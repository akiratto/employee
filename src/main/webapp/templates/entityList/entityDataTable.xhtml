<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:jsf="http://xmlns.jcp.org/jsf"
      xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">
    <h:head>
        <title>entityDataTable</title>
    </h:head>
    <h:body>
        <ui:composition>
            <!-- 変数準備 -->
            <c:set var="jsfUIIdField" 
                   value="#{entityReflectionBean.getJsfUIIdField(entityListBean.searchCondition)}" />
            <c:set var="jsfUIInternalIdField"
                    value="#{entityReflectionBean.getJsfUIInternalIdField(entityListBean.searchCondition)}" />
            
            <!-- エンティティの一覧表の表示部分 -->
            <c:if test="#{     (not empty jsfUIIdField) 
                           and (not empty jsfUIInternalIdField)
                           and (jsfUIIdField.hasJsfUIListColumn())
                           }">
                <!-- エンティティの@JsfUIIdFieldを指定したフィールドが存在し、
                     かつ、そのフィールドに@JsfUIListColumnが指定されていること  -->
                
                <!-- データが存在しない場合はメッセージを表示する -->
                <h:outputText value="#{entityListBean.setting.messageEntityNotFoundInDataTable()}"
                               rendered="#{empty entityListBean.entities}"
                               style="display: block;margin-top:16px;"/>

                <!-- データが1件以上存在する場合、一覧表の上部のナビゲートを表示 -->
                <div style="position: relative;width:1000px;height:30px;"
                     jsf:rendered="#{not empty entityListBean.entities}">

                    <!-- ナビゲート部分  表示例) 前へ 1 2 3 4 5 次へ -->
                    <div id="topPageNavigator">
                        <h:commandLink action="#{entityListBean.pageNavigator.prevPage()}"
                                        value="前へ"
                                        rendered="#{entityListBean.pageNavigator.prevPageEnabled()}"
                                        style="margin-right:0.6em;"/>
                        <ui:repeat value="#{entityListBean.pageNavigator.pageLinks}" var="p">
                            <!-- ページ番号が現在のページならリンク有で表示 -->
                            <h:commandLink action="#{p.moveToPage()}" 
                                            value="#{p.pageNo}" 
                                            rendered="#{not p.isCurrentPage()}"
                                            style="margin-right:0.6em;" />

                            <!-- ページ番号が現在のページ以外ならリンク無で表示 -->
                            <h:outputText value="#{p.pageNo}"
                                           rendered="#{p.isCurrentPage()}"
                                           style="font-weight: bold;margin-right:0.6em;" />
                        </ui:repeat>
                        <h:commandLink action="#{entityListBean.pageNavigator.nextPage()}"
                                        value="次へ"
                                        rendered="#{entityListBean.pageNavigator.nextPageEnabled()}" />
                    </div>
                    <!-- 一覧表の表示範囲、最大件数 を表示 -->
                    <div id="countInfo">
                        <h:outputText value="#{entityListBean.setting.messageDisplayRangeInDataTable(
                                                                            entityListBean.entityAllCount,
                                                                            entityListBean.pageNavigator.beginRowIndex, 
                                                                            entityListBean.pageNavigator.endRowIndex)}" />
                    </div>
                </div>
                
                <!-- データが1件以上存在する場合、ソートボタンを表示 -->
                <h:commandButton value="昇順" action="#{entityListBean.sortAscending()}" rendered="#{not empty entityListBean.entities}" />
                <h:commandButton value="降順" action="#{entityListBean.sortDescending()}" rendered="#{not empty entityListBean.entities}" />

                <!-- データが1件以上存在する場合、一覧表を表示 -->
                <h:dataTable id="employee_list"
                              styleClass="employee_list" 
                              value="#{entityListBean.entityDataModel}" 
                              var="emp"  
                              rendered="#{not empty entityListBean.entities}">

                    <!-- 削除ボタン -->
                    <h:column>
                        <f:facet name="header">
                            <h:outputText value="ボタン" />
                        </f:facet>
                        <h:commandButton id="delete_button"
                                          value="削除" 
                                          onclick="return confirm(F3(this,'delete_confirm_message'))"
                                          action="#{entityListBean.delete( entityReflectionBean.getJsfUIInternalIdField(emp).value )}" />
                        <div id="delete_confirm_message_#{entityListBean.entityDataModel.rowIndex}" style="display:none">#{entityListBean.setting.messageDeleteConfirmInDataTable( entityReflectionBean.getJsfUIIdField(emp).value )}</div>
                    </h:column>

                    <!-- エンティティのIDカラム -->
                    <h:column>
                        <f:facet name="header">
                            <h:outputText value="#{jsfUIIdField.jsfUIListColumn.labelTitle()}" /> <!-- entityReflectionBean.getJsfUIIdField(emp).jsfUIListColumn.labelTitle() はempがnullになるのでエラーとなる。facetは評価のタイミングが違う？ -->
                        </f:facet>
                        <h:commandLink action="#{entityListBean.gotoDetail(entityReflectionBean.getJsfUIInternalIdField(emp).value, 'Read')}">
                            <h:outputText value="#{entityReflectionBean.getJsfUIIdField(emp).value}" />
                        </h:commandLink>
                    </h:column>

                    <c:forEach var="fd" items="#{entityReflectionBean.getEntityFieldsWithJsfUIListColumn(entityListBean.searchCondition)}">
                        <c:if test="#{not fd.hasJsfUIId() and not fd.hasJsfUIInternalId()}">
                            <c:if test="#{fd.jsfUIListColumn.columnType().eqHtmlInputText()}">
                                <h:column>
                                    <f:facet name="header">
                                        <h:outputText value="#{fd.jsfUIListColumn.labelTitle()}" />
                                    </f:facet>
                                    <ui:fragment rendered="#{entityReflectionBean.findEntityField(emp, fd.name).hasJsfUIListColumnConverter()}">
                                        #{entityReflectionBean.findEntityField(emp, fd.name).valueAsString}
                                    </ui:fragment>
                                    <ui:fragment rendered="#{not entityReflectionBean.findEntityField(emp, fd.name).hasJsfUIListColumnConverter()}">
                                        #{entityReflectionBean.findEntityField(emp, fd.name).value}
                                    </ui:fragment>
                                </h:column>
                            </c:if>
                        </c:if>
                    </c:forEach>
                </h:dataTable>
                
            </c:if>
            
            <!-- データが1件以上存在する場合、一覧表の下部のナビゲートを表示 -->
            <p style="width:1000px; text-align:center;">
                
                <h:commandLink action="#{entityListBean.pageNavigator.prevPage()}" 
                                value="前へ" 
                                rendered="#{entityListBean.pageNavigator.prevPageEnabled()}" 
                                style="margin-right:0.6em;"/>
                <ui:repeat value="#{entityListBean.pageNavigator.pageLinks}" var="p">
                    <h:commandLink action="#{p.moveToPage()}"
                                    value="#{p.pageNo}" 
                                    rendered="#{not p.isCurrentPage()}" 
                                    style="margin-right:0.6em;" />
                    <h:outputText value="#{p.pageNo}"
                                   rendered="#{p.isCurrentPage()}" 
                                   style="font-weight: bold;margin-right:0.6em;" />
                </ui:repeat>
                <h:commandLink action="#{entityListBean.pageNavigator.nextPage()}" 
                                value="次へ" 
                                rendered="#{entityListBean.pageNavigator.nextPageEnabled()}" />
            </p>
            <ui:debug hotkey="K" rendered="#{initParam['facelets.DEVELOPMENT']}" />
        </ui:composition>
    </h:body>
</html>

